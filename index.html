<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluación de Presupuesto — Riesgo Crediticio MLOps</title>
  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --line: #dbe3ef;
      --text: #1a2a3a;
      --muted: #54657a;
      --primary: #1f4f82;
      --primary-2: #2f6ba8;
      --ok: #1e8e3e;
      --warn: #e38b00;
      --bad: #c53030;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 18px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(20, 40, 80, 0.05);
    }
    h1, h2, h3 { margin: 0 0 8px; }
    p, li { line-height: 1.45; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .progress {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .step {
      border: 1px solid var(--line);
      background: #eef3fa;
      color: #3a4d65;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    .step.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .row { display: grid; gap: 10px; grid-template-columns: repeat(12, 1fr); align-items: end; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-12 { grid-column: span 12; }
    label { font-weight: 600; font-size: 0.92rem; }
    input[type="text"], input[type="email"], input[type="number"], select, textarea {
      width: 100%;
      border: 1px solid #bac8dc;
      border-radius: 8px;
      padding: 8px;
      font-size: 0.92rem;
      background: #fff;
    }
    textarea { min-height: 64px; resize: vertical; }
    button {
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: #e3ebf7; color: #1c3554; }
    .btn-primary:hover { background: var(--primary-2); }
    .actions { display: flex; justify-content: space-between; gap: 8px; margin-top: 16px; }
    .hidden { display: none; }
    .table-wrap { overflow-x: auto; border: 1px solid var(--line); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 1400px; }
    th, td { border-bottom: 1px solid #e7edf7; padding: 6px; font-size: 0.85rem; vertical-align: top; }
    th { background: #f0f5fc; position: sticky; top: 0; z-index: 1; }
    .small { font-size: 0.8rem; color: var(--muted); }
    .tag { display: inline-block; border-radius: 12px; padding: 2px 8px; font-size: 0.8rem; color: #fff; }
    .ok { background: var(--ok); }
    .warn { background: var(--warn); }
    .bad { background: var(--bad); }
    .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .metric { border: 1px solid var(--line); border-radius: 8px; padding: 8px; background: #fbfdff; }
    .metric strong { display: block; font-size: 1.1rem; margin-top: 4px; }
    .status-list { margin: 0; padding-left: 18px; }
    .q-card { border: 1px solid var(--line); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .result-score { font-size: 2rem; color: var(--primary); font-weight: 700; }
    .footer-note { margin-top: 16px; color: #4f6075; font-size: 0.9rem; }
    .error { color: var(--bad); font-size: 0.85rem; margin-top: 4px; }
    details { margin-top: 6px; }
    @media (max-width: 900px) {
      .row { grid-template-columns: repeat(1, 1fr); }
      .col-6, .col-4, .col-3, .col-12 { grid-column: span 1; }
      .metrics { grid-template-columns: repeat(2, 1fr); }
      .progress { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Actividad Evaluativa: Diseño de Esquema Presupuestario</h1>
  <p class="muted">Caso de maestría: Plataforma de riesgo crediticio con MLOps y cumplimiento regulatorio (Ecuador).</p>

  <div class="progress" id="progressBar">
    <div class="step active">1. Caso</div>
    <div class="step">2. Presupuesto</div>
    <div class="step">3. Cuestionario</div>
    <div class="step">4. Resultados</div>
  </div>

  <section id="screenStart" class="card">
    <h2>Inicio</h2>
    <div class="row">
      <div class="col-6">
        <label>Nombres y Apellidos *</label>
        <input id="studentName" type="text" placeholder="Ej.: Ana María Pérez Gómez" />
        <div id="nameError" class="error hidden">Ingrese al menos 8 caracteres y 2 palabras.</div>
      </div>
      <div class="col-6">
        <label>Correo (opcional)</label>
        <input id="studentEmail" type="email" placeholder="correo@institucion.edu" />
      </div>
    </div>
    <div class="actions"><span></span><button class="btn-primary" id="btnStart">Iniciar caso</button></div>
  </section>

  <section id="screenCase" class="card hidden">
    <h2>Caso: Implementación de una Plataforma de Riesgo Crediticio con MLOps y Cumplimiento Regulatorio en Cooperativas (Ecuador)</h2>
    <h3>1) Contexto</h3>
    <p>Una red de cooperativas de ahorro y crédito busca implementar, en 12 meses, una plataforma analítica para evaluación de riesgo crediticio y monitoreo de morosidad. El fondo financiador exige transparencia, límites de overhead y sostenibilidad operativa.</p>
    <h3>2) Objetivo del proyecto</h3>
    <p>Diseñar un presupuesto integral CAPEX/OPEX que soporte rendimiento de modelos, gobernanza, cumplimiento, continuidad operativa y adopción organizacional.</p>
    <h3>3) Alcance (entregables)</h3>
    <ol>
      <li>ETL y data mart analítico.</li><li>Modelo de scoring baseline + avanzado y validación.</li><li>MLOps mínimo viable.</li>
      <li>Auditoría técnica (explicabilidad, sesgo, trazabilidad).</li><li>Capacitación y cumplimiento.</li><li>Manuales y continuidad.</li>
    </ol>
    <h3>4) Implicancias</h3>
    <ul>
      <li>Evitar sobreingeniería sin adopción real.</li>
      <li>Cumplimiento y auditoría son no negociables.</li>
      <li>OSS puede reducir licencias, pero requiere soporte/seguridad.</li>
      <li>Subestimar calidad de datos compromete el scoring.</li>
      <li>Sin capacitación, la solución no se usa.</li>
    </ul>
    <h3>5) Restricciones duras</h3>
    <ul>
      <li>Máximo financiable: USD 125,000 (incluye impuestos).</li>
      <li>Overhead ≤ 12%, CAPEX ≤ 25%, Capacitación+Cambio ≥ 10%, Auditoría/Compliance ≥ 8%.</li>
      <li>Contingencia entre 5% y 8%.</li>
      <li>PAO1 ≥ 45% y PAO2 ≤ 55% del total.</li>
    </ul>
    <h3>6) Supuestos</h3>
    <p>Horizonte 12 meses; inflación 4% anual para costos recurrentes; USD sin tipo de cambio; mínimo un rubro explícito de seguridad/soporte.</p>

    <label><input type="checkbox" id="caseRead" /> He leído y comprendo el caso.</label>
    <div class="actions"><button class="btn-secondary" id="backToStart">Atrás</button><button class="btn-primary" id="toBudget" disabled>Continuar a presupuesto</button></div>
  </section>

  <section id="screenBudget" class="card hidden">
    <h2>Módulo 1: Construcción del presupuesto</h2>
    <p class="small">Ajuste cantidades/costos editables para cumplir restricciones. Justifique al menos 8 rubros y asigne PAO para todos.</p>
    <div class="table-wrap"><table id="budgetTable"><thead><tr>
      <th>#</th><th>Categoría</th><th>Rubro</th><th>Unidad</th><th>Cantidad</th><th>Unitario</th><th>Subtotal</th><th>IVA</th><th>Total rubro</th><th>PAO</th><th>Comentario (0-200)</th>
    </tr></thead><tbody></tbody></table></div>

    <div class="metrics" id="metricsBox"></div>
    <h3>Validación de restricciones</h3>
    <ul class="status-list" id="statusList"></ul>

    <div class="actions"><button class="btn-secondary" id="backToCase">Atrás</button><button class="btn-primary" id="toQuiz">Continuar a cuestionario</button></div>
  </section>

  <section id="screenQuiz" class="card hidden">
    <h2>Módulo 2: Cuestionario</h2>
    <div id="quizContainer"></div>
    <div class="actions"><button class="btn-secondary" id="backToBudget">Atrás</button><button class="btn-primary" id="toResults">Calificar y ver resultados</button></div>
  </section>

  <section id="screenResults" class="card hidden">
    <h2>Resultados</h2>
    <div class="result-score" id="finalScore">0/100</div>
    <p id="qualitative"></p>
    <h3>Retroalimentación</h3>
    <ul id="feedbackList"></ul>
    <h3>Detalle de puntajes</h3>
    <ul id="scoreBreakdown"></ul>
    <div class="actions">
      <button class="btn-secondary" id="backToQuiz">Atrás</button>
      <button class="btn-primary" id="btnPdf">Descargar PDF</button>
    </div>
    <p id="pdfWarning" class="error hidden">No se pudo cargar el módulo PDF; copie/pegue resultados.</p>
    <p class="footer-note">Generado automáticamente — evaluación formativa de presupuestación (nivel maestría).</p>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(() => {
  const IVA_RATE = 0.12;
  const INFLATION = 0.04;
  const state = {
    student: { name: "", email: "", id: "", startedAt: null },
    rows: [],
    computed: {},
    quizAnswers: {}
  };

  const rowsDef = [
    {id:1, cat:"Personal interno", item:"Líder de datos (PM/DS)", unit:"mes", qty:8, qtyMin:6, qtyMax:10, qtyE:true, unitCost:1600, unitMin:1600, unitMax:1600, unitE:false, iva:false, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:2, cat:"Personal interno", item:"Ingeniero de datos", unit:"mes", qty:6, qtyMin:4, qtyMax:8, qtyE:true, unitCost:1400, unitMin:1400, unitMax:1400, unitE:false, iva:false, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:3, cat:"Personal interno", item:"Analista de riesgo", unit:"mes", qty:4, qtyMin:3, qtyMax:6, qtyE:true, unitCost:1200, unitMin:1200, unitMax:1200, unitE:false, iva:false, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:4, cat:"Servicios externos", item:"Consultoría MLOps/Seguridad", unit:"paquete", qty:1, qtyMin:1, qtyMax:1, qtyE:false, unitCost:10000, unitMin:8000, unitMax:14000, unitE:true, iva:true, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:5, cat:"Servicios externos", item:"Validación externa del modelo (auditoría)", unit:"paquete", qty:1, qtyMin:1, qtyMax:1, qtyE:false, unitCost:6500, unitMin:6500, unitMax:6500, unitE:false, iva:true, capex:false, train:false, audit:true, overhead:false, contingency:false, pao:"PAO2"},
    {id:6, cat:"Servicios externos", item:"Taller legal/compliance", unit:"paquete", qty:1, qtyMin:1, qtyMax:1, qtyE:false, unitCost:3200, unitMin:3200, unitMax:3200, unitE:false, iva:true, capex:false, train:false, audit:true, overhead:false, contingency:false, pao:"PAO2"},
    {id:7, cat:"Infraestructura y herramientas", item:"Servidor on-prem (CAPEX)", unit:"unidad", qty:1, qtyMin:0, qtyMax:2, qtyE:true, unitCost:9500, unitMin:9500, unitMax:9500, unitE:false, iva:true, capex:true, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:8, cat:"Infraestructura y herramientas", item:"Laptops técnicas (CAPEX)", unit:"unidad", qty:2, qtyMin:0, qtyMax:4, qtyE:true, unitCost:1250, unitMin:1250, unitMax:1250, unitE:false, iva:true, capex:true, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:9, cat:"Infraestructura y herramientas", item:"Nube / cómputo", unit:"mes", qty:8, qtyMin:6, qtyMax:12, qtyE:true, unitCost:550, unitMin:350, unitMax:900, unitE:true, iva:true, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:10, cat:"Datos y calidad", item:"Integración/limpieza de datos", unit:"paquete", qty:1, qtyMin:1, qtyMax:1, qtyE:false, unitCost:6000, unitMin:4000, unitMax:9000, unitE:true, iva:true, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:11, cat:"Datos y calidad", item:"Backups + continuidad", unit:"mes", qty:10, qtyMin:6, qtyMax:12, qtyE:true, unitCost:180, unitMin:180, unitMax:180, unitE:false, iva:true, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO2"},
    {id:12, cat:"Capacitación y cambio", item:"Capacitación analistas", unit:"sesión", qty:6, qtyMin:4, qtyMax:10, qtyE:true, unitCost:420, unitMin:420, unitMax:420, unitE:false, iva:true, capex:false, train:true, audit:false, overhead:false, contingency:false, pao:"PAO2"},
    {id:13, cat:"Capacitación y cambio", item:"Gestión del cambio", unit:"paquete", qty:1, qtyMin:1, qtyMax:1, qtyE:false, unitCost:5000, unitMin:3500, unitMax:7500, unitE:true, iva:true, capex:false, train:true, audit:false, overhead:false, contingency:false, pao:"PAO2"},
    {id:14, cat:"Viajes y levantamiento", item:"Visitas técnicas a CAC", unit:"viaje", qty:6, qtyMin:4, qtyMax:12, qtyE:true, unitCost:260, unitMin:260, unitMax:260, unitE:false, iva:true, capex:false, train:false, audit:false, overhead:false, contingency:false, pao:"PAO1"},
    {id:15, cat:"Overhead administrativo", item:"Administración del proyecto", unit:"% subtotal sin IVA", qty:9, qtyMin:6, qtyMax:12, qtyE:true, unitCost:0, unitMin:0, unitMax:0, unitE:false, iva:false, capex:false, train:false, audit:false, overhead:true, contingency:false, pao:"PAO1"},
    {id:16, cat:"Contingencia", item:"Contingencia", unit:"% subtotal sin IVA", qty:6, qtyMin:5, qtyMax:8, qtyE:true, unitCost:0, unitMin:0, unitMax:0, unitE:false, iva:false, capex:false, train:false, audit:false, overhead:false, contingency:true, pao:"PAO2"}
  ];

  state.rows = rowsDef.map(r => ({...r, comment:""}));

  const screens = {
    start: byId("screenStart"), case: byId("screenCase"), budget: byId("screenBudget"), quiz: byId("screenQuiz"), results: byId("screenResults")
  };

  const questionDefs = [
    {id:"p1", type:"num", text:"P1. Total del presupuesto con IVA (USD, 2 decimales).", hint:"Incluye subtotal sin IVA + IVA + overhead + contingencia."},
    {id:"p2", type:"num", text:"P2. % Overhead sobre el total final (2 decimales).", hint:"Use el rubro de overhead y divídalo para total final."},
    {id:"p3", type:"num", text:"P3. % Capacitación+Gestión del cambio sobre total final (2 decimales).", hint:"Considere rubros 12 y 13 con IVA."},
    {id:"p4", type:"num", text:"P4. % CAPEX (servidor+laptops) sobre total final (2 decimales).", hint:"Considere rubros 7 y 8 con IVA."},
    {id:"p5", type:"mcq", text:"P5. Hallazgo de sesgo: rubro más responsable de mitigarlo sin frenar operación.", options:["A) Nube / cómputo","B) Validación externa del modelo","C) Servidor on-prem","D) Viajes técnicos"], answer:"B", hint:"Piense en auditoría independiente y control de sesgo."},
    {id:"p6", type:"mcq", text:"P6. Decisión que reduce mejor sobreingeniería manteniendo cumplimiento.", options:["A) Eliminar auditoría externa","B) Reducir capacitación al mínimo","C) Priorizar calidad de datos y cambio organizacional antes de duplicar infraestructura","D) Maximizar CAPEX para robustez"], answer:"C", hint:"Se busca equilibrio entre adopción, datos y control."},
    {id:"p7", type:"mcq", text:"P7. Con presupuesto limitado, combinación que mejor sostiene continuidad operativa.", options:["A) Laptops + viajes","B) Backups/continuidad + nube razonable","C) Servidor extra + más visitas","D) Reducir MLOps y subir CAPEX"], answer:"B", hint:"Continuidad depende de respaldo y operación."},
    {id:"p8", type:"mcq", text:"P8. Riesgo principal de subfinanciar Integración/Limpieza de datos.", options:["A) Mayor IVA","B) Drift de mercado","C) Errores sistémicos y baja validez del scoring","D) Más overhead"], answer:"C", hint:"Sin calidad de datos, el modelo aprende mal."},
    {id:"p9", type:"open", text:"P9. (80–120 palabras) Justifique PAO1/PAO2 por dependencia ETL→modelo→MLOps→adopción y riesgo.", hint:"Mencione secuencia técnica y al menos un riesgo."},
    {id:"p10", type:"open", text:"P10. (60–100 palabras) Dos riesgos residuales y cómo los mitiga (o limitación).", hint:"Debe incluir 2 riesgos y 2 mitigaciones/limitaciones."}
  ];

  function byId(id){ return document.getElementById(id); }
  function fmt(n){ return Number(n || 0).toLocaleString("en-US", {minimumFractionDigits:2, maximumFractionDigits:2}); }
  function updateProgress(idx){ [...byId("progressBar").children].forEach((el, i) => el.classList.toggle("active", i===idx)); }
  function showScreen(key){ Object.values(screens).forEach(s => s.classList.add("hidden")); screens[key].classList.remove("hidden"); }

  function renderTable(){
    const tb = byId("budgetTable").querySelector("tbody");
    tb.innerHTML = "";
    state.rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.cat}</td>
        <td>${r.item}</td>
        <td>${r.unit}</td>
        <td>${r.overhead||r.contingency ? `<input type="number" min="${r.qtyMin}" max="${r.qtyMax}" step="0.01" value="${r.qty}" data-k="qty" data-id="${r.id}">` :
          r.qtyE ? `<input type="number" min="${r.qtyMin}" max="${r.qtyMax}" step="1" value="${r.qty}" data-k="qty" data-id="${r.id}">` : r.qty}</td>
        <td>${r.unitE ? `<input type="number" min="${r.unitMin}" max="${r.unitMax}" step="10" value="${r.unitCost}" data-k="unit" data-id="${r.id}">` : fmt(r.unitCost)}</td>
        <td id="sub-${r.id}">0.00</td>
        <td id="iva-${r.id}">0.00</td>
        <td id="tot-${r.id}">0.00</td>
        <td><select data-k="pao" data-id="${r.id}"><option ${r.pao==="PAO1"?"selected":""}>PAO1</option><option ${r.pao==="PAO2"?"selected":""}>PAO2</option></select></td>
        <td><textarea maxlength="200" data-k="comment" data-id="${r.id}" placeholder="Justificación técnica/financiera">${r.comment||""}</textarea><div class="small">${(r.comment||"").length}/200</div></td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll("input,select,textarea").forEach(el => {
      el.addEventListener("input", ev => {
        const id = Number(ev.target.dataset.id);
        const key = ev.target.dataset.k;
        const row = state.rows.find(x => x.id === id);
        if (key === "qty") {
          row.qty = clamp(Number(ev.target.value), row.qtyMin, row.qtyMax);
          ev.target.value = row.qty;
        }
        if (key === "unit") {
          row.unitCost = clamp(Number(ev.target.value), row.unitMin, row.unitMax);
          ev.target.value = row.unitCost;
        }
        if (key === "pao") row.pao = ev.target.value;
        if (key === "comment") {
          row.comment = ev.target.value.slice(0,200);
          ev.target.nextElementSibling.textContent = `${row.comment.length}/200`;
        }
        recalc();
      });
    });
  }

  function clamp(v, mn, mx){ if (isNaN(v)) return mn; return Math.max(mn, Math.min(mx, v)); }

  function recalc(){
    const baseRows = state.rows.filter(r => !r.overhead && !r.contingency);
    let subtotalNoIVA = 0, taxableBase = 0;
    const cats = {};

    baseRows.forEach(r => {
      let subtotal = r.qty * (r.unitCost || 0);
      if (r.item === "Nube / cómputo" || r.item === "Backups + continuidad") subtotal *= (1 + INFLATION * (r.qty/12));
      const iva = r.iva ? subtotal * IVA_RATE : 0;
      const total = subtotal + iva;
      r.subtotal = subtotal; r.ivaVal = iva; r.total = total;
      subtotalNoIVA += subtotal;
      taxableBase += r.iva ? subtotal : 0;
      cats[r.cat] = (cats[r.cat] || 0) + total;
    });

    const overheadRow = state.rows.find(r => r.overhead);
    overheadRow.subtotal = subtotalNoIVA * overheadRow.qty / 100;
    overheadRow.ivaVal = 0; overheadRow.total = overheadRow.subtotal;
    cats[overheadRow.cat] = overheadRow.total;

    const contingencyRow = state.rows.find(r => r.contingency);
    contingencyRow.subtotal = subtotalNoIVA * contingencyRow.qty / 100;
    contingencyRow.ivaVal = 0; contingencyRow.total = contingencyRow.subtotal;
    cats[contingencyRow.cat] = contingencyRow.total;

    const totalIVA = taxableBase * IVA_RATE;
    const totalFinal = subtotalNoIVA + totalIVA + overheadRow.total + contingencyRow.total;
    const capex = state.rows.filter(r => r.capex).reduce((a,b)=>a+b.total,0);
    const training = state.rows.filter(r => r.train).reduce((a,b)=>a+b.total,0);
    const audit = state.rows.filter(r => r.audit).reduce((a,b)=>a+b.total,0);
    const pao1 = state.rows.filter(r => r.pao === "PAO1").reduce((a,b)=>a+(b.total||0),0);
    const pao2 = state.rows.filter(r => r.pao === "PAO2").reduce((a,b)=>a+(b.total||0),0);
    const pct = (x) => totalFinal ? (x*100/totalFinal) : 0;

    state.computed = {
      subtotalNoIVA, totalIVA, totalFinal, capex, training, audit,
      overhead: overheadRow.total, contingency: contingencyRow.total,
      overheadPct: pct(overheadRow.total), capexPct: pct(capex), trainingPct: pct(training), auditPct: pct(audit), contPct: pct(contingencyRow.total),
      pao1, pao2, pao1Pct: pct(pao1), pao2Pct: pct(pao2),
      cats
    };

    state.rows.forEach(r => {
      byId(`sub-${r.id}`).textContent = fmt(r.subtotal||0);
      byId(`iva-${r.id}`).textContent = fmt(r.ivaVal||0);
      byId(`tot-${r.id}`).textContent = fmt(r.total||0);
    });

    renderMetrics();
    renderValidation();
  }

  function statusLine(ok, txt){
    const tag = ok ? '<span class="tag ok">Cumple</span>' : '<span class="tag bad">No cumple</span>';
    return `<li>${tag} ${txt}</li>`;
  }

  function renderMetrics(){
    const c = state.computed;
    byId("metricsBox").innerHTML = `
      <div class="metric"><div>Total final</div><strong>USD ${fmt(c.totalFinal)}</strong></div>
      <div class="metric"><div>Subtotal sin IVA</div><strong>USD ${fmt(c.subtotalNoIVA)}</strong></div>
      <div class="metric"><div>IVA total</div><strong>USD ${fmt(c.totalIVA)}</strong></div>
      <div class="metric"><div>Overhead</div><strong>${fmt(c.overheadPct)}%</strong></div>
      <div class="metric"><div>CAPEX</div><strong>${fmt(c.capexPct)}%</strong></div>
      <div class="metric"><div>Capacitación + cambio</div><strong>${fmt(c.trainingPct)}%</strong></div>
      <div class="metric"><div>Auditoría/compliance</div><strong>${fmt(c.auditPct)}%</strong></div>
      <div class="metric"><div>Contingencia</div><strong>${fmt(c.contPct)}%</strong></div>
      <div class="metric"><div>PAO1</div><strong>${fmt(c.pao1Pct)}%</strong></div>
      <div class="metric"><div>PAO2</div><strong>${fmt(c.pao2Pct)}%</strong></div>
    `;
  }

  function renderValidation(){
    const c = state.computed;
    const validations = [
      [c.totalFinal<=125000, `Techo USD 125,000. Actual: USD ${fmt(c.totalFinal)}`],
      [c.overheadPct<=12, `Overhead ≤ 12%. Actual: ${fmt(c.overheadPct)}%`],
      [c.capexPct<=25, `CAPEX ≤ 25%. Actual: ${fmt(c.capexPct)}%`],
      [c.trainingPct>=10, `Capacitación + cambio ≥ 10%. Actual: ${fmt(c.trainingPct)}%`],
      [c.auditPct>=8, `Auditoría/compliance ≥ 8%. Actual: ${fmt(c.auditPct)}%`],
      [c.contPct>=5 && c.contPct<=8, `Contingencia 5% a 8%. Actual: ${fmt(c.contPct)}%`],
      [c.pao1Pct>=45, `PAO1 ≥ 45%. Actual: ${fmt(c.pao1Pct)}%`],
      [c.pao2Pct<=55, `PAO2 ≤ 55%. Actual: ${fmt(c.pao2Pct)}%`],
      [state.rows.filter(r => r.comment.trim().length>0).length>=8, `Justificación en al menos 8 rubros. Actual: ${state.rows.filter(r => r.comment.trim().length>0).length}`],
      [state.rows.some(r => r.item.toLowerCase().includes("seguridad")), `Existe rubro de seguridad/soporte operativo.`]
    ];
    byId("statusList").innerHTML = validations.map(v => statusLine(v[0], v[1])).join("");
  }

  function renderQuiz(){
    const qWrap = byId("quizContainer");
    qWrap.innerHTML = "";
    questionDefs.forEach(q => {
      const div = document.createElement("div");
      div.className = "q-card";
      let body = `<label>${q.text}</label>`;
      if (q.type === "num") body += `<input type="number" step="0.01" data-q="${q.id}">`;
      if (q.type === "mcq") body += q.options.map(opt => `<label style="display:block;font-weight:400;"><input type="radio" name="${q.id}" value="${opt[0]}" data-q="${q.id}"> ${opt}</label>`).join("");
      if (q.type === "open") body += `<textarea data-q="${q.id}" placeholder="Respuesta"></textarea>`;
      body += `<details><summary>Pista</summary><p class="small">${q.hint}</p></details>`;
      div.innerHTML = body;
      qWrap.appendChild(div);
    });
    qWrap.querySelectorAll("input,textarea").forEach(el => {
      el.addEventListener("input", e => {
        const q = e.target.dataset.q;
        if (e.target.type === "radio") {
          const selected = qWrap.querySelector(`input[name="${q}"]:checked`);
          state.quizAnswers[q] = selected ? selected.value : "";
        } else {
          state.quizAnswers[q] = e.target.value;
        }
      });
    });
  }

  function scoreAll(){
    const c = state.computed;
    const sb = [];
    const add = (name, pts, detail) => sb.push({name, pts, detail});

    const scorePercentBound = (actual, target, maxPts, type) => {
      const ok = type === "max" ? actual <= target : actual >= target;
      if (ok) return maxPts;
      const diff = Math.abs(actual - target);
      return diff <= 1 ? maxPts - 3 : 0;
    };

    let a1 = 10;
    if (c.totalFinal > 125000) a1 = (c.totalFinal - 125000 <= 500) ? 5 : 0;
    add("A1 Techo", a1, `Total ${fmt(c.totalFinal)}`);
    add("A2 Overhead", scorePercentBound(c.overheadPct, 12, 10, "max"), `${fmt(c.overheadPct)}%`);
    add("A3 CAPEX", scorePercentBound(c.capexPct, 25, 10, "max"), `${fmt(c.capexPct)}%`);
    add("A4 Capacitación+cambio", scorePercentBound(c.trainingPct, 10, 10, "min"), `${fmt(c.trainingPct)}%`);
    add("A5 Auditoría/compliance", scorePercentBound(c.auditPct, 8, 10, "min"), `${fmt(c.auditPct)}%`);

    let a6c = scorePercentBound(c.contPct, 5, 5, "min");
    if (c.contPct > 8) a6c = Math.abs(c.contPct-8) <= 1 ? 2 : 0;
    let a6p = (c.pao1Pct>=45 && c.pao2Pct<=55) ? 5 : 0;
    if (!a6p && Math.max(45-c.pao1Pct, c.pao2Pct-55) <= 1) a6p = 2;
    add("A6 Contingencia + PAO", a6c + a6p, `Cont ${fmt(c.contPct)}%, PAO1 ${fmt(c.pao1Pct)}%, PAO2 ${fmt(c.pao2Pct)}%`);

    const corr = {
      p1: c.totalFinal,
      p2: c.overheadPct,
      p3: c.trainingPct,
      p4: c.capexPct
    };
    ["p1","p2","p3","p4"].forEach(pid => {
      const ans = Number(state.quizAnswers[pid]);
      const target = corr[pid];
      const tol = pid === "p1" ? target * 0.005 : 0.1;
      const pts = Math.abs(ans-target) <= tol ? 6 : 0;
      add(pid.toUpperCase(), pts, `Resp: ${isNaN(ans)?"N/A":fmt(ans)} / Correcto: ${fmt(target)}`);
    });

    ["p5","p6","p7","p8"].forEach(pid => {
      const q = questionDefs.find(x => x.id===pid);
      add(pid.toUpperCase(), state.quizAnswers[pid]===q.answer ? 3 : 0, `Resp: ${state.quizAnswers[pid]||"N/A"}`);
    });

    const p9 = (state.quizAnswers.p9||"").trim();
    const p9ok = wordsBetween(p9,80,120) && /etl/i.test(p9) && /modelo/i.test(p9) && /mlops/i.test(p9) && /adop/i.test(p9) && /(riesgo|drift|sesgo|continuidad|cumplimiento)/i.test(p9);
    add("P9 abierta", p9ok ? 2 : 0, `Palabras: ${countWords(p9)}`);

    const p10 = (state.quizAnswers.p10||"").trim();
    const riskHits = (p10.match(/riesgo/gi)||[]).length;
    const mitHits = (p10.match(/mitig|control|conting|limitaci/gi)||[]).length;
    const p10ok = wordsBetween(p10,60,100) && riskHits>=2 && mitHits>=2;
    add("P10 abierta", p10ok ? 2 : 0, `Palabras: ${countWords(p10)}`);

    const total = sb.reduce((a,b)=>a+b.pts,0);
    return {total, sb};
  }

  function countWords(t){ return (t.trim().match(/\S+/g)||[]).length; }
  function wordsBetween(t,min,max){ const w = countWords(t); return w>=min && w<=max; }

  function qualitative(n){ if (n>=90) return "Excelente"; if (n>=80) return "Muy bueno"; if (n>=70) return "Bueno"; if (n>=60) return "Suficiente"; return "Insuficiente"; }

  function buildFeedback(){
    const c = state.computed;
    const f = [];
    if (c.totalFinal>125000) f.push(`Excede techo en USD ${fmt(c.totalFinal-125000)}; reduzca nube/consultoría o CAPEX para volver a límite.`);
    if (c.capexPct>25) f.push(`CAPEX en ${fmt(c.capexPct)}%; reduzca 1 servidor o laptops para bajar ≤25%.`);
    if (c.trainingPct<10) f.push(`Capacitación+cambio en ${fmt(c.trainingPct)}%; incremente rubros 12/13 para adopción.`);
    if (c.auditPct<8) f.push(`Auditoría/compliance en ${fmt(c.auditPct)}%; refuerce validación/documentación.`);
    if (c.overheadPct>12) f.push(`Overhead en ${fmt(c.overheadPct)}%; ajuste porcentaje administrativo.`);
    if (c.contPct<5 || c.contPct>8) f.push(`Contingencia en ${fmt(c.contPct)}%; ajuste entre 5% y 8%.`);
    if (c.pao1Pct<45) f.push(`PAO1 bajo (${fmt(c.pao1Pct)}%); mueva construcción base al primer semestre.`);
    if (c.pao2Pct>55) f.push(`PAO2 alto (${fmt(c.pao2Pct)}%); redistribuya ejecución temprana.`);
    if (!f.length) f.push("Cumple restricciones duras con adecuada coherencia técnico-financiera.");
    if (state.rows.filter(r => r.comment.trim()).length<8) f.push("Agregue justificación en al menos 8 rubros para trazabilidad de decisiones.");
    f.push("Revise riesgos residuales: calidad de datos, sesgo del modelo y continuidad ante incidentes.");
    return f;
  }

  function renderResults(){
    const scored = scoreAll();
    const fb = buildFeedback();
    byId("finalScore").textContent = `${scored.total}/100`;
    byId("qualitative").textContent = `Calificación cualitativa: ${qualitative(scored.total)}`;
    byId("feedbackList").innerHTML = fb.map(x=>`<li>${x}</li>`).join("");
    byId("scoreBreakdown").innerHTML = scored.sb.map(s=>`<li><strong>${s.name}:</strong> ${s.pts} pts <span class="small">(${s.detail})</span></li>`).join("");
    state.lastScore = scored;
    state.lastFeedback = fb;
  }

  function downloadPdf(){
    if (!window.jspdf || !window.jspdf.jsPDF) { byId("pdfWarning").classList.remove("hidden"); return; }
    byId("pdfWarning").classList.add("hidden");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"pt", format:"a4"});
    let y = 36;
    const line = (t, inc=14) => { doc.text(String(t), 36, y); y += inc; if (y > 790) { doc.addPage(); y = 36; } };
    const c = state.computed;

    doc.setFontSize(12);
    line("Resultado de evaluación de presupuesto");
    doc.setFontSize(10);
    line(`Nombre: ${state.student.name}`); line(`ID intento: ${state.student.id}`); line(`Fecha/hora: ${new Date().toLocaleString()}`);
    y += 4; line("Resumen del caso: Implementación de plataforma de riesgo crediticio con MLOps, auditoría y adopción, sujeta a restricciones de fondo y sostenibilidad.");
    y += 8; line("Resumen por categorías (total y %):");
    Object.entries(c.cats).forEach(([k,v]) => line(`- ${k}: USD ${fmt(v)} (${fmt(v*100/c.totalFinal)}%)`));
    y += 8; line("Rubros detallados:");
    state.rows.forEach(r => line(`#${r.id} ${r.item} | Cant ${r.qty} | Unit ${fmt(r.unitCost)} | Total ${fmt(r.total||0)} | ${r.pao} | ${r.comment||"(sin comentario)"}`));
    y += 8; line("Respuestas cuestionario:");
    questionDefs.forEach(q => line(`${q.id.toUpperCase()}: ${state.quizAnswers[q.id] || "(sin respuesta)"}`));
    y += 8; line("Puntaje por criterio:");
    state.lastScore.sb.forEach(s => line(`- ${s.name}: ${s.pts} pts`));
    line(`TOTAL: ${state.lastScore.total}/100 (${qualitative(state.lastScore.total)})`);
    y += 8; line("Observaciones automáticas:");
    state.lastFeedback.forEach(f => line(`- ${f}`));
    y += 10;
    line("Generado automáticamente — evaluación formativa de presupuestación (nivel maestría)");

    const safeName = state.student.name.replace(/\s+/g,"_").replace(/[^\wÁÉÍÓÚáéíóúÑñ_-]/g,"");
    doc.save(`Resultado_Presupuesto_${safeName}_${state.student.id}.pdf`);
  }

  byId("btnStart").addEventListener("click", () => {
    const name = byId("studentName").value.trim();
    const valid = name.length >= 8 && name.split(/\s+/).length >= 2;
    byId("nameError").classList.toggle("hidden", valid);
    if (!valid) return;
    state.student.name = name;
    state.student.email = byId("studentEmail").value.trim();
    state.student.id = `${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
    state.student.startedAt = new Date().toISOString();
    updateProgress(0); showScreen("case");
  });

  byId("backToStart").addEventListener("click", () => { showScreen("start"); updateProgress(0); });
  byId("caseRead").addEventListener("change", e => byId("toBudget").disabled = !e.target.checked);
  byId("toBudget").addEventListener("click", () => { showScreen("budget"); updateProgress(1); recalc(); });
  byId("backToCase").addEventListener("click", () => { showScreen("case"); updateProgress(0); });

  byId("toQuiz").addEventListener("click", () => { showScreen("quiz"); updateProgress(2); renderQuiz(); });
  byId("backToBudget").addEventListener("click", () => { showScreen("budget"); updateProgress(1); });

  byId("toResults").addEventListener("click", () => { renderResults(); showScreen("results"); updateProgress(3); });
  byId("backToQuiz").addEventListener("click", () => { showScreen("quiz"); updateProgress(2); });
  byId("btnPdf").addEventListener("click", downloadPdf);

  renderTable();
  recalc();
})();
</script>
</body>
</html>
